From bfd85e24c90752e64c49c2d3dce1a224ca46a863 Mon Sep 17 00:00:00 2001
From: Tiago Vignatti <tiago.vignatti@intel.com>
Date: Mon, 1 Jul 2013 19:10:53 -0300
Subject: [PATCH 4/7] Chromium: Add Wayland implementation gyp dependency on
 Ozone

Signed-off-by: Tiago Vignatti <tiago.vignatti@intel.com>
---
 build/common.gypi                        |    6 ++++++
 content/shell/app/shell_main_delegate.cc |    6 ++++++
 ui/aura/aura.gyp                         |    5 +++++
 ui/aura/demo/demo_main.cc                |    6 ++++++
 4 files changed, 23 insertions(+)

diff --git a/build/common.gypi b/build/common.gypi
index 29f1278..21379a3 100644
--- a/build/common.gypi
+++ b/build/common.gypi
@@ -138,6 +138,12 @@
             'toolkit_uses_gtk%': 0,
           }],
 
+          ['use_ozone==1', {
+            'dependencies': [
+              '<(DEPTH)/ozone/ozone_impl.gyp:wayland',
+            ]
+          }],
+
           # Enable HiDPI on Mac OS and Chrome OS.
           ['OS=="mac" or chromeos==1', {
             'enable_hidpi%': 1,
diff --git a/content/shell/app/shell_main_delegate.cc b/content/shell/app/shell_main_delegate.cc
index b5adadb..6c1054c 100644
--- a/content/shell/app/shell_main_delegate.cc
+++ b/content/shell/app/shell_main_delegate.cc
@@ -24,6 +24,8 @@
 #include "ui/base/ui_base_switches.h"
 #include "ui/gl/gl_switches.h"
 
+#include "ozone/surface_factory_wayland.h"
+
 #include "ipc/ipc_message.h"  // For IPC_MESSAGE_LOG_ENABLED.
 
 #if defined(IPC_MESSAGE_LOG_ENABLED)
@@ -165,6 +167,10 @@ bool ShellMainDelegate::BasicStartupComplete(int* exit_code) {
 
 void ShellMainDelegate::PreSandboxStartup() {
   InitializeResourceBundle();
+
+  /* TODO: Implementation specific. Has to go away */
+  ui::SurfaceFactoryOzone *o_factory = new ui::SurfaceFactoryWayland ();
+  ui::SurfaceFactoryOzone::SetInstance(o_factory);
 }
 
 int ShellMainDelegate::RunProcess(
diff --git a/ui/aura/aura.gyp b/ui/aura/aura.gyp
index a4fe861..760ff82 100644
--- a/ui/aura/aura.gyp
+++ b/ui/aura/aura.gyp
@@ -128,6 +128,11 @@
             '../../ipc/ipc.gyp:ipc',
           ],
         }],
+        ['use_ozone==1', {
+          'dependencies': [
+            '../../ozone/ozone_impl.gyp:wayland',
+          ]
+        }],
       ],
     },
     {
diff --git a/ui/aura/demo/demo_main.cc b/ui/aura/demo/demo_main.cc
index aea286e..3d317bc 100644
--- a/ui/aura/demo/demo_main.cc
+++ b/ui/aura/demo/demo_main.cc
@@ -22,6 +22,8 @@
 #include "ui/gfx/canvas.h"
 #include "ui/gfx/rect.h"
 
+#include "ozone/surface_factory_wayland.h"
+
 #if defined(USE_X11)
 #include "base/message_loop/message_pump_aurax11.h"
 #endif
@@ -107,6 +109,10 @@ class DemoStackingClient : public aura::client::StackingClient {
 };
 
 int DemoMain() {
+  /* TODO: Implementation specific. Has to go away */
+  ui::SurfaceFactoryOzone *o_factory = new ui::SurfaceFactoryWayland ();
+  ui::SurfaceFactoryOzone::SetInstance(o_factory);
+
   // Create the message-loop here before creating the root window.
   base::MessageLoop message_loop(base::MessageLoop::TYPE_UI);
   aura::Env::GetInstance();
-- 
1.7.9.5

