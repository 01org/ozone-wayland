From 3dad365d0d03ca1ced3e766b974df10a627fac81 Mon Sep 17 00:00:00 2001
From: Tiago Vignatti <tiago.vignatti@intel.com>
Date: Fri, 12 Jul 2013 19:13:33 -0300
Subject: [PATCH 7/7] content/browser: Use in-process for 3D contexts

This has to be properly implemented later to use command buffer (GPU process).

Signed-off-by: Tiago Vignatti <tiago.vignatti@intel.com>
---
 content/browser/aura/image_transport_factory.cc |    5 +++++
 content/browser/browser_main_loop.cc            |    3 ++-
 2 files changed, 7 insertions(+), 1 deletion(-)

diff --git a/content/browser/aura/image_transport_factory.cc b/content/browser/aura/image_transport_factory.cc
index 2e92dd0..94372a2 100644
--- a/content/browser/aura/image_transport_factory.cc
+++ b/content/browser/aura/image_transport_factory.cc
@@ -22,6 +22,10 @@ void ImageTransportFactory::Initialize() {
   if (command_line->HasSwitch(switches::kTestCompositor)) {
     ui::SetupTestCompositor();
   }
+#if defined(USE_OZONE)
+    // XXX: hack for in-process only 3D contexts
+    g_factory = new NoTransportImageTransportFactory(NULL);
+#else
   if (ui::IsTestCompositorEnabled()) {
     g_factory = new NoTransportImageTransportFactory(
         new ui::TestContextFactory);
@@ -29,6 +33,7 @@ void ImageTransportFactory::Initialize() {
     g_factory = new GpuProcessTransportFactory;
   }
   ui::ContextFactory::SetInstance(g_factory->AsContextFactory());
+#endif
 }
 
 // static
diff --git a/content/browser/browser_main_loop.cc b/content/browser/browser_main_loop.cc
index 1c6b1a0..d8d19cd 100644
--- a/content/browser/browser_main_loop.cc
+++ b/content/browser/browser_main_loop.cc
@@ -650,7 +650,8 @@ int BrowserMainLoop::PreMainMessageLoopRun() {
   // If the UI thread blocks, the whole UI is unresponsive.
   // Do not allow disk IO from the UI thread.
   base::ThreadRestrictions::SetIOAllowed(false);
-  base::ThreadRestrictions::DisallowWaiting();
+  // InProcessCommandBuffer::Initialize needs Wait() (r19522006)
+  //base::ThreadRestrictions::DisallowWaiting();
   return result_code_;
 }
 
-- 
1.7.9.5

