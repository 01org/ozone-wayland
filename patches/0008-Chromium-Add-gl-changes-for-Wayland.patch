From a007dc6fa9b04d6791e5fc75e3a90341a6a5f4fd Mon Sep 17 00:00:00 2001
From: Tiago Vignatti <tiago.vignatti@intel.com>
Date: Mon, 1 Jul 2013 19:10:53 -0300
Subject: [PATCH 08/10] Chromium: Add gl changes for Wayland

TODO: needs to check whether this can be upstreamed.

Signed-off-by: Tiago Vignatti <tiago.vignatti@intel.com>
---
 ui/base/ozone/surface_factory_ozone.cc |    2 +-
 ui/base/ozone/surface_factory_ozone.h  |    3 +--
 ui/gl/gl_surface_egl.cc                |    8 +++-----
 3 files changed, 5 insertions(+), 8 deletions(-)

diff --git a/ui/base/ozone/surface_factory_ozone.cc b/ui/base/ozone/surface_factory_ozone.cc
index a617efe..bbfdffc 100644
--- a/ui/base/ozone/surface_factory_ozone.cc
+++ b/ui/base/ozone/surface_factory_ozone.cc
@@ -16,7 +16,7 @@ class SurfaceFactoryOzoneStub : public SurfaceFactoryOzone {
   SurfaceFactoryOzoneStub() {}
   virtual ~SurfaceFactoryOzoneStub() {}
 
-  virtual void InitializeHardware() OVERRIDE {}
+  virtual intptr_t InitializeHardware() OVERRIDE { return 0; }
   virtual void ShutdownHardware() OVERRIDE {}
   virtual gfx::AcceleratedWidget GetAcceleratedWidget() OVERRIDE { return 0; }
   virtual gfx::AcceleratedWidget RealizeAcceleratedWidget(
diff --git a/ui/base/ozone/surface_factory_ozone.h b/ui/base/ozone/surface_factory_ozone.h
index d98882d..72062b0 100644
--- a/ui/base/ozone/surface_factory_ozone.h
+++ b/ui/base/ozone/surface_factory_ozone.h
@@ -30,10 +30,9 @@ class SurfaceFactoryOzone {
   // Sets the implementation delegate. Ownership is retained by the caller.
   UI_EXPORT static void SetInstance(SurfaceFactoryOzone* impl);
 
-  // TODO(rjkroege): Add a status code if necessary.
   // Configures the display hardware. Must be called from within the GPU
   // process before the sandbox has been activated.
-  virtual void InitializeHardware() = 0;
+  virtual intptr_t InitializeHardware() = 0;
 
   // Cleans up display hardware state. Call this from within the GPU process.
   // This method must be safe to run inside of the sandbox.
diff --git a/ui/gl/gl_surface_egl.cc b/ui/gl/gl_surface_egl.cc
index 8c29342..fc57aef 100644
--- a/ui/gl/gl_surface_egl.cc
+++ b/ui/gl/gl_surface_egl.cc
@@ -101,10 +101,8 @@ bool GLSurfaceEGL::InitializeOneOff() {
     return true;
 
 #if defined (USE_OZONE)
-  ui::SurfaceFactoryOzone::GetInstance()->InitializeHardware();
-#endif
-
-#if defined(USE_X11)
+  g_native_display = ui::SurfaceFactoryOzone::GetInstance()->InitializeHardware();
+#elif defined(USE_X11)
   g_native_display = base::MessagePumpForUI::GetDefaultXDisplay();
 #elif defined(OS_WIN)
   g_native_display = EGL_DEFAULT_DISPLAY;
@@ -134,7 +132,7 @@ bool GLSurfaceEGL::InitializeOneOff() {
     EGL_GREEN_SIZE, 8,
     EGL_RED_SIZE, 8,
     EGL_RENDERABLE_TYPE, EGL_OPENGL_ES2_BIT,
-    EGL_SURFACE_TYPE, EGL_WINDOW_BIT | EGL_PBUFFER_BIT,
+    EGL_SURFACE_TYPE, EGL_WINDOW_BIT,
     EGL_NONE
   };
 
-- 
1.7.9.5

